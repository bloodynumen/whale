// Generated by CoffeeScript 1.10.0
(function() {
  define('whale', ['jquery', 'jqueryui', 'jqueryform'], function($) {
    var func_link, path_list, side_menu, whale;
    whale = {
      getPathList: function() {
        return window.location.pathname.split('/');
      },
      refresh: function() {
        return document.location.reload();
      },
      getHost: function() {
        return window.location.protocol + '#' + window.location.host;
      },
      path: window.location.pathname,
      getDataObj: function(obj) {
        var parent;
        if (obj.attr('data-attr')) {
          return $.parseJSON(obj.attr('data-attr'));
        }
        parent = obj.closest('[data-attr]');
        if (parent.length) {
          return $.parseJSON(parent.attr('data-attr'));
        }
        return {};
      },
      queryString: (function() {
        var arr, j, len, pair, query, query_string, unit, vars;
        query_string = {};
        query = window.location.search.substring(1);
        vars = query.split("&");
        for (j = 0, len = vars.length; j < len; j++) {
          unit = vars[j];
          pair = unit.split("=");
          if (typeof query_string[pair[0]] === "undefined") {
            query_string[pair[0]] = pair[1];
          } else if (typeof query_string[pair[0]] === "string") {
            arr = [query_string[pair[0]], pair[1]];
            query_string[pair[0]] = arr;
          } else {
            query_string[pair[0]].push(pair[1]);
          }
        }
        return query_string;
      })(),
      formDialog: function(tpl, settings) {
        var defaultSettings, effects;
        effects = ['blind', 'clip', 'drop', 'explode', 'fold', 'puff', 'slide', 'scale', 'size', 'pulsate'];
        defaultSettings = {
          ajaxForm: {
            beforeSubmit: function(arr, formObj, options) {
              var emptyField;
              emptyField = [];
              $.each(arr, function(i, field) {
                if (!field.value && (formObj.find('[name=' + field.name + ']').attr('allow_empty') !== 'true')) {
                  emptyField.push(field.name);
                  return console.log(field.name);
                }
              });
              if (emptyField.length !== 0) {
                $.whaleTip({
                  refresh: false,
                  tip: "请填写完整数据"
                });
                return false;
              }
            },
            success: function(res) {
              var refresh;
              refresh = false;
              if (res.errno === 22000) {
                refresh = true;
              }
              return $.whaleTip({
                refresh: refresh,
                tip: res.msg,
                closeTime: 1500
              });
            },
            error: function() {
              return $.whaleTip({
                refresh: false,
                tip: "网络请求失败"
              });
            }
          },
          dialog: {
            show: effects[Math.floor(Math.random() * effects.length)],
            hide: effects[Math.floor(Math.random() * effects.length)],
            title: '',
            width: 320,
            height: 'auto',
            afterOpen: function(dialog) {
              return false;
            }
          }
        };
        settings = $.extend(true, defaultSettings, settings);
        return $(tpl).dialog({
          show: settings.dialog.show,
          hide: settings.dialog.hide,
          title: settings.dialog.title,
          width: settings.dialog.width,
          height: settings.dialog.height,
          open: function(event, ui) {
            $(this).bind("keypress", function(event) {
              if (event.keyCode === $.ui.keyCode.ENTER) {
                $(".ui-dialog-buttonpane button").first().click();
                return false;
              }
            });
            settings.dialog.afterOpen($(this));
          },
          buttons: {
            "确认": function() {
              return $(this).find('form').ajaxSubmit(settings.ajaxForm);
            },
            "取消": function() {
              return $(this).dialog("close");
            }
          }
        });
      }
    };
    path_list = window.location.pathname.split('/');
    whale.app_path = path_list[1];
    whale.pathname = window.location.pathname;
    if (whale.pathname !== whale.app_path) {
      side_menu = $('#side-menu');
      func_link = side_menu.find('li[class!="sidebar-search"] ul li a[href^="' + whale.pathname + '"]');
      if (func_link.length > 0) {
        func_link.each(function(i) {
          var href, li_obj;
          href = $(this).attr('href');
          li_obj = $(this).parent().parent().parent();
          li_obj.addClass('active');
          li_obj.find('ul').removeClass('collapse').addClass('in');
          $(this).addClass('nav-selected');
          return false;
        });
      }
    }
    $.extend({
      whaleAjax: function($settings) {
        var $defaultSettings;
        $defaultSettings = {
          type: 'GET',
          async: false,
          dataType: 'json',
          success: function(msg) {
            alert(msg.msg);
            if (msg.errno === 0 || msg.errno === 22000) {
              return whale.refresh();
            }
          },
          error: function() {
            return alert("请求失败");
          }
        };
        $settings = $.extend($defaultSettings, $settings);
        return $.ajax($settings);
      }
    });
    $.extend({
      whaleAjaxTip: function($settings) {
        var $defaultSettings, closeTime;
        closeTime = $settings.closeTime ? $settings.closeTime : 10;
        delete $settings.closeTime;
        $defaultSettings = {
          type: 'GET',
          async: false,
          dataType: 'json',
          success: function(msg) {
            var $refresh;
            $refresh = false;
            if (msg.errno === 0 || msg.errno === 22000) {
              $refresh = true;
            }
            return $.whaleTip({
              refresh: $refresh,
              tip: msg.msg,
              closeTime: closeTime
            });
          },
          error: function() {
            return alert("请求失败");
          }
        };
        $settings = $.extend($defaultSettings, $settings);
        return $.ajax($settings);
      }
    });
    $.extend({
      whaleTip: function($tipSettings) {
        var $closeTime, $defaultTipSettings, $refresh, $tip, tpl;
        $tip = $tipSettings.tip ? $tipSettings.tip : '';
        $closeTime = $tipSettings.closeTime ? $tipSettings.closeTime : 1500;
        $refresh = $tipSettings.refresh;
        delete $tipSettings.msg;
        delete $tipSettings.closeTime;
        delete $tipSettings.refresh;
        tpl = '';
        tpl += '<div style="padding:5px 20px">';
        tpl += '<p style="font-size:14pxpadding-top:10px"><span class="ui-icon ui-icon-alert" style="float:left margin:0 7px 20px 0"></span><span class="ajaxMsg">' + $tip + '</span></p>';
        tpl += '<span id="error_info" style="color:red"></span>';
        tpl += '</div>';
        $defaultTipSettings = {
          title: '提示',
          slow: 'slide',
          width: 320,
          open: function(event, ui) {
            var $dialog, callback;
            $(this).bind("keypress", function(event) {
              return $(this).dialog('close');
            });
            $dialog = $(this);
            callback = function() {
              $dialog.dialog('close');
              if ($refresh) {
                return document.location.reload();
              }
            };
            return setTimeout(callback, $closeTime);
          }
        };
        $tipSettings = $.extend($defaultTipSettings, $tipSettings);
        return $(tpl).dialog($tipSettings);
      }
    });
    return whale;
  });

}).call(this);
